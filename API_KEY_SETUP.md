# Securely Using API Keys with GitHub Pages (e.g., Google TTS)

## The Problem

GitHub Pages serves static websites directly from your repository. Committing sensitive information like API keys directly into your repository (`main` branch or similar) is a major security risk, as it becomes publicly visible in your code history. Furthermore, client-side JavaScript running in the user's browser cannot directly access secrets stored securely on GitHub.

## The Solution: GitHub Secrets + Build Process (GitHub Actions)

The secure way to handle API keys for GitHub Pages involves:

1.  **Storing the key securely:** Use **GitHub Secrets**.
2.  **Injecting the key during deployment:** Use a **GitHub Actions workflow** that runs a script *only* within the secure runner environment. This script inserts the key into the necessary files just before deployment.
3.  **Deploying the built result:** Deploy the modified files (containing the key) to a dedicated deployment branch (e.g., `gh-pages`).
4.  **Serving from the deployment branch:** Configure GitHub Pages to serve your site from this deployment branch.

## Step-by-Step Implementation

### Step 1: Add API Key as a GitHub Secret

1.  Go to your repository on GitHub.
2.  Click **Settings**.
3.  In the left sidebar, navigate to **Secrets and variables** > **Actions**.
4.  Click the **New repository secret** button.
5.  Enter a name for your secret (e.g., `GOOGLE_TTS_API_KEY`). **Remember this name.**
6.  Paste your actual API key into the **Secret** field.
7.  Click **Add secret**. The key is now stored securely and encrypted.

### Step 2: Create an Injection Script

Create a simple Node.js script in your repository (e.g., `update-api-key.js`) that will be run by the GitHub Action. Its job is to read the API key from an environment variable (passed in by the Action) and write it into a configuration file that your client-side code can use.

**Example: `update-api-key.js`**

```javascript
// Script to update/create config files during build
const fs = require('fs');

// Get API key from environment variable set by GitHub Actions
const apiKey = process.env.GOOGLE_TTS_API_KEY; // Matches the secret name

if (!apiKey) {
  console.error('Error: GOOGLE_TTS_API_KEY environment variable is not set in the build environment!');
  process.exit(1);
} else {
  console.log('API key found in environment variable. Creating config.js...');
}

// Create config.js - this file WILL contain the key and be deployed
try {
  const configContent = `// Configuration generated during build
const config = {
    googleTTSApiKey: '${apiKey}' // API key set during build process
};`;

  fs.writeFileSync('config.js', configContent); // Overwrites or creates config.js
  console.log('Successfully created config.js with API key.');
} catch (error) {
  console.error(`Error creating config.js: ${error.message}`);
  process.exit(1);
}

// You could add other steps here if needed, like replacing placeholders
// in other files (though using a single config file is often cleaner).
```

**Important:** Add a `config.js` file to your `.gitignore` file to prevent accidentally committing the version generated locally (which might contain a placeholder or a test key). The deployed version will be generated by the Action.

```gitignore
# .gitignore
config.js
# ... other entries
```

### Step 3: Configure GitHub Actions Workflow

Create a workflow file (e.g., `.github/workflows/deploy.yml`) to automate the build and deployment process.

**Example: `.github/workflows/deploy.yml`**

```yaml
name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # Trigger deployment on push to main branch

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write # Needed for deploy action to push to gh-pages
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Or your preferred Node version

      # Optional: Install dependencies if your injection script needs them
      # - name: Install dependencies
      #   run: npm install

      - name: Inject API Key and Create Config
        env:
          # Pass the secret to the script as an environment variable
          GOOGLE_TTS_API_KEY: ${{ secrets.GOOGLE_TTS_API_KEY }}
        run: node update-api-key.js # Run the injection script

      # Optional: Verify config.js was created (good practice)
      - name: Verify config.js creation
        run: |
          if [ -f config.js ]; then
            echo "✅ config.js created successfully."
            # Check if API key looks like it was inserted (optional, basic check)
            if grep -q "AIza" config.js; then
               echo "✅ API key seems present in config.js."
            else
               echo "❌ WARNING: API key pattern not found in config.js!"
               # Decide if this should fail the build: exit 1
            fi
          else
            echo "❌ ERROR: config.js not found after injection step!"
            exit 1
          fi

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          # Deploy the current state of the workspace (including generated config.js)
          folder: .
          # Deploy to the 'gh-pages' branch (or your chosen deployment branch)
          branch: gh-pages
          # Use GITHUB_TOKEN for authentication
          token: ${{ secrets.GITHUB_TOKEN }}
          # Clean the deployment branch before deploying
          clean: true
```

### Step 4: Access Key in Client-Side JavaScript

Your client-side JavaScript (`app.js`, `google-tts.js`, etc.) should **never** try to access `process.env`. Instead, it should use the configuration object created by the build script.

1.  **Include `config.js`:** Make sure your `index.html` includes the generated `config.js` *before* any scripts that need the key.

    ```html
    <!-- index.html -->
    <body>
        <!-- ... your app structure ... -->

        <script src="config.js"></script> <!-- Load the generated config -->
        <script src="google-tts.js"></script>
        <script src="app.js"></script>
    </body>
    ```

2.  **Use the `config` object:** Access the key via the global `config` object defined in `config.js`.

    ```javascript
    // Example in google-tts.js or similar
    class GoogleTTSManager {
        constructor() {
            // Read key from the global config object generated during build
            this.apiKey = (typeof config !== 'undefined' && config.googleTTSApiKey) ? config.googleTTSApiKey : '';

            if (!this.apiKey) {
                console.error("TTS Error: API Key not found in config.js!");
            }
            // ... rest of constructor
        }

        async synthesizeSpeech(text) {
            if (!this.apiKey) {
                // Handle error or use fallback
                return;
            }
            const apiUrl = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.apiKey}`;
            // ... make API call ...
        }
    }
    ```

### Step 5: Configure GitHub Pages Source Branch

1.  Go to your repository **Settings**.
2.  Navigate to **Pages** in the left sidebar.
3.  Under **Build and deployment**, ensure the **Source** is set to **Deploy from a branch**.
4.  Select the **branch** that your GitHub Action deploys to (e.g., `gh-pages`).
5.  Ensure the **folder** is set to `/ (root)`.
6.  Click **Save**.

## Security Summary

*   Your sensitive API key lives only in **GitHub Secrets**.
*   Your source code (`main` branch) remains clean and **does not contain the key**.
*   The key is only exposed temporarily within the **secure GitHub Actions runner** environment during the build.
*   The build process injects the key into the necessary file (`config.js`).
*   Only the **built output** (including the key in `config.js`) is pushed to the deployment branch (`gh-pages`).
*   GitHub Pages serves the site **from the `gh-pages` branch**.

## Important Consideration: Client-Side Key Visibility

While this process prevents the key from being in your source code repository history, the API key *will* be present in the deployed JavaScript files (`config.js` in this example) served to the user's browser. Anyone inspecting the site's loaded resources can find it.

For some APIs (like Google TTS), this is often unavoidable as the API call must be made directly from the client. **It is crucial to restrict your API key** in the Google Cloud Console (or your API provider's dashboard) to minimize potential abuse. For Google APIs, you should restrict the key by:

*   **HTTP referrers:** Allow requests only from your specific GitHub Pages domain (e.g., `your-username.github.io`).
*   **API restrictions:** Only allow the key to be used with the specific APIs it needs (e.g., the Text-to-Speech API).

This significantly reduces the risk if someone extracts the key from your deployed site, as it won't work from other websites or for other Google services. 